---
import { Icon } from "@iconify/react";
import config from "explainer.config";

interface Props {
  class?: string;
  "data-language"?: string;
  "data-label"?: string;
  [key: string]: unknown;
}

const {
  class: className,
  "data-language": language,
  "data-label": label,
  ...props
} = Astro.props;

const displayLabel = label || language || "text";
const displayLanguage = language || "text";

let icon =
  config.content.icons[displayLabel.toLowerCase()] ||
  config.content.icons[displayLanguage.toLowerCase()] ||
  "mdi:code-tags";

if (["bash", "sh", "shell"].includes(displayLanguage.toLowerCase())) {
  const html = await Astro.slots.render("default");
  const text = html.replace(/<[^>]+>/g, "").trim();
  const match = text.match(/^(\w+)/);
  if (match) {
    const cmd = match[1].toLowerCase();
    const terminalFilter = ["npm", "npx", "pnpm", "yarn", "bun", "cargo"];

    if (terminalFilter.includes(cmd) && config.content.icons[cmd]) {
      icon = config.content.icons[cmd];
    }
  }
}
---

<div
  class="code-block group relative my-4 rounded-lg border bg-background overflow-hidden text-sm"
>
  {
    label && (
      <div class="code-block-header flex items-center gap-2 border-b bg-background px-4 py-2.5">
        <Icon
          client:load
          icon={icon}
          className="size-4 text-muted-foreground"
        />
        <span class="font-medium text-muted-foreground">{displayLabel}</span>
      </div>
    )
  }
  <div class="relative">
    <pre
      class={className}
      data-language={language}
      data-label={label}
      {...props}><slot /></pre>
  </div>
</div>

<style is:global>
  .code-block pre {
    margin: 0 !important;
    border-radius: 0 !important;
    border: none !important;
  }

  .code-group .code-block {
    margin: 0;
    border: none;
    border-radius: 0;
    background: transparent;
  }

  .code-group .code-block .code-block-header {
    display: none;
  }
</style>
