---
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import DocsLayout from "@/layouts/DocsLayout.astro";
import { render, getCollection, type CollectionEntry } from "astro:content";
import config from "../../../explainer.config";

import { useDocumentation, buildHeadingTree } from "../../lib/utils";
import * as astroContent from "astro:content";
import DocNavigationWrapper from "@/components/elements/DocNavigationWrapper.astro";
import { Icon } from "@iconify/react";
import BlogListWrapper from "@/plugins/blog-list/BlogListWrapper.astro";
import H2 from "@/components/content/heading/h2.astro";
import H3 from "@/components/content/heading/h3.astro";

interface Props {
  element: CollectionEntry<"blog">;
}

export async function getStaticPaths() {
  const { generateStaticPaths } = useDocumentation(astroContent);
  return generateStaticPaths();
}

const { element } = Astro.props;
const { Content, headings } = await render(element);

const issueUrl = config.repository + "/issues/new";
const repositoryUrl = config.repository + "/blob/main/" + element.filePath;

const availableHeadings = headings.filter((heading) =>
  [2, 3].includes(heading.depth),
);

const headingTree = buildHeadingTree(availableHeadings);

const docDefaults = await getCollection("docDefaults");
const segments = element.id.split("/");
const breadcrumbItems: { label: string; href: string }[] = [];

for (let i = 0; i < segments.length - 1; i++) {
  const defaultId = segments.slice(0, i + 1).join("/") + "/_default";
  const entry = docDefaults.find((d) => d.id === defaultId);
  const href = "/docs/" + segments.slice(0, i + 1).join("/");
  breadcrumbItems.push({
    label: entry?.data.label ?? segments[i],
    href,
  });
}
---

<DocsLayout
  id={element.id}
  title={element.data?.title}
  description={element.data?.description}
>
  <div class="lg:col-span-8">
    <div class="flex flex-col lg:grid lg:grid-cols-10 lg:gap-8">
      <div class="lg:col-span-8 py-6 px-4">
        <div class="mb-2.5">
          <Breadcrumb>
            <BreadcrumbList>
              {
                breadcrumbItems.map((item) => (
                  <>
                    <BreadcrumbItem>
                      <BreadcrumbLink
                        href={item.href}
                        className="text-foreground"
                      >
                        {item.label}
                      </BreadcrumbLink>
                    </BreadcrumbItem>
                    <BreadcrumbSeparator />
                  </>
                ))
              }
              <BreadcrumbItem>
                <BreadcrumbPage className="text-primary font-medium">
                  {element.data.title}
                </BreadcrumbPage>
              </BreadcrumbItem>
            </BreadcrumbList>
          </Breadcrumb>
        </div>

        {
          headingTree.length ? (
            <details class="xl:hidden border rounded-lg px-4 py-3 mb-4 group">
              <summary class="text-sm font-semibold cursor-pointer flex items-center justify-between text-muted-foreground">
                <span>On this page</span>
                <svg
                  class="h-4 w-4 transition-transform group-open:rotate-180"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </summary>
              <ul class="mt-2 ms-2.5 ps-4 border-s border-secondary">
                {headingTree.map((heading) => (
                  <li>
                    <a
                      href={`#${heading.slug}`}
                      class="text-sm flex items-center py-1 text-muted-foreground hover:text-primary transition-colors"
                    >
                      {heading.text}
                    </a>
                    <ul class="ms-3">
                      {heading.children.map((child) => (
                        <li>
                          <a
                            href={`#${child.slug}`}
                            class="text-sm flex items-center py-1 text-muted-foreground hover:text-primary transition-colors"
                          >
                            <span class="truncate">{child.text}</span>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </li>
                ))}
              </ul>
            </details>
          ) : null
        }

        <div class="prose">
          <Content components={config.content.components} />
        </div>

        <div
          data-orientation="horizontal"
          role="separator"
          class="flex items-center align-center text-center w-full flex-row pt-20"
        >
          <div class="border-default w-full border-solid border-t"></div>
          <div class="font-medium text-default flex mx-3 whitespace-nowrap">
            <div class="flex items-center gap-2 text-sm text-muted-foreground">
              <a
                href={issueUrl}
                rel="noopener noreferrer"
                target="_blank"
                class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 transition-colors px-2.5 py-1.5 text-xs gap-1.5 text-muted-foreground hover:text-default disabled:text-muted aria-disabled:text-muted focus:outline-none focus-visible:ring-inset focus-visible:ring-2 focus-visible:ring-inverted"
              >
                <Icon
                  client:visible
                  icon="lucide:circle-alert"
                  className="size-4"
                />
                Report an issue
              </a>
              or
              <a
                href={repositoryUrl}
                rel="noopener noreferrer"
                target="_blank"
                class="rounded-md font-medium inline-flex items-center disabled:cursor-not-allowed aria-disabled:cursor-not-allowed disabled:opacity-75 aria-disabled:opacity-75 transition-colors px-2.5 py-1.5 text-xs gap-1.5 text-muted-foreground hover:text-default disabled:text-muted aria-disabled:text-muted focus:outline-none focus-visible:ring-inset focus-visible:ring-2 focus-visible:ring-inverted"
              >
                <Icon client:visible icon="lucide:pencil" className="size-4" />
                Edit this page on GitHub
              </a>
            </div>
          </div>
          <div class="border-default w-full border-solid border-t"></div>
        </div>

        <DocNavigationWrapper />
      </div>

      {/* Table of contents */}
      {
        headingTree.length ? (
          <aside class="hidden xl:block w-64">
            <div class="fixed top-14 p-4 overflow-y-auto h-[calc(100vh-4rem)]">
              <p class="group text-sm font-semibold flex-1 items-center gap-1.5 py-1.5 -mt-1.5 focus-visible:outline-primary hidden lg:flex">
                <span class="truncate">On this page</span>
              </p>

              <ul class="min-w-0 ms-2.5 ps-4 border-s border-secondary">
                {headingTree.map((heading) => (
                  <li>
                    <a
                      href={`#${heading.slug}`}
                      class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted-foreground hover:text-primary transition-colors"
                    >
                      {heading.text}
                    </a>
                    <ul class="ms-3">
                      {heading.children.map((child) => (
                        <li class="min-w-0 -ms-px">
                          <a
                            href={`#${child.slug}`}
                            class="group relative text-sm flex items-center focus-visible:outline-primary py-1 text-muted-foreground hover:text-primary transition-colors"
                          >
                            <span class="truncate">{child.text}</span>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </li>
                ))}
              </ul>
            </div>
          </aside>
        ) : null
      }
    </div>
  </div>
</DocsLayout>
