---
import { render, getCollection } from "astro:content";
import config from "../../explainer.config";
import Layout from "@/layouts/Layout.astro";
import HeroSection from "@/components/elements/hero-section.astro";
import FeaturesSection from "@/components/elements/features-section.astro";
import HighlightsSection from "@/components/elements/highlights-section.astro";
import TestimonialsSection from "@/components/elements/testimonials-section.astro";
import CtaSection from "@/components/elements/cta-section.astro";
import BlogSection from "@/components/elements/blog-section.astro";

export async function getStaticPaths() {
  const allPages = await getCollection("pages");

  function pathToSlug(entry: { id: string }) {
    const parts = entry.id.split("/");
    const lastPart = parts.at(-1);

    if (lastPart === "index") {
      parts.splice(parts.length - 1, 1, "/");
    }

    return parts.length > 0 ? parts.join("/") : "/";
  }

  return allPages.map((p) => {
    return {
      params: { page: pathToSlug(p) },
      props: { page: p },
    };
  });
}

const allPages = await getCollection("pages");
const slug = Astro.params.page ? Astro.params.page.split("/") : ["/"];

const page = allPages.find((p) => {
  const parts = p.id.split("/");
  const lastPart = parts.at(-1);

  if (lastPart === "index") {
    parts.splice(parts.length - 1, 1, "/");
  }

  const currentPage = parts.length > 0 ? parts.join("/") : "/";
  return currentPage === slug.join("/");
});

if (!page) throw Astro.redirect("/404");

const { Content } = await render(page);
---

<Layout>
  <Content
    components={{
      ...config.content.components,
      "hero-section": HeroSection,
      "features-section": FeaturesSection,
      "highlights-section": HighlightsSection,
      "testimonials-section": TestimonialsSection,
      "cta-section": CtaSection,
      "blog-section": BlogSection,
    }}
  />
</Layout>
